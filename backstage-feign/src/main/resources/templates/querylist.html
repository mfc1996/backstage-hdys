<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Title</title>

</head>
<script src="../js/jquery.min.js"></script>
<script src="../js/bootstrap-datetimepicker/js/bootstrap-datetimepicker.js"></script>
<link type="text/css" rel="stylesheet" href="../js/bootstrap3/css/bootstrap.css"></link>
<link type="text/css" rel="stylesheet" href="../js/bootstrap-table/bootstrap-table.css"></link>
<link type="text/css" rel="stylesheet" href="../js/bootstrap-datetimepicker/css/bootstrap-datetimepicker.css"></link>
<link type="text/css" rel="stylesheet" href="../js/bootstrap-fileinput/css/fileinput.css"></link>
<link rel="stylesheet" type="text/css" href="../js/uploadify/uploadify.css" />

<script src="../js/bootstrap3/js/bootstrap.js"></script>
<script src="../js/bootstrap-bootbox/bootbox.js"></script>
<script src="../js/bootstrap-table/bootstrap-table.js"></script>
<script src="../js/bootstrap-table/locale/bootstrap-table-zh-CN.js"></script>
<script src="../js/bootstrap-datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js"></script>
<script src="../js/bootstrap-fileinput/js/fileinput.js"></script>
<script src="../js/bootstrap-fileinput/js/locales/zh.js"></script>
<script type="text/javascript" src="../js/uploadify/jquery.uploadify.min.js"></script>

<body>

<div>
    <form class="form-inline" id="toolbar">
        <button onclick="delAll()" type="button" class="btn btn-primary glyphicon glyphicon-minus">批量删除</button>
        <button onclick="openUser()" type="button" class="btn btn-primary glyphicon glyphicon-plus">新增</button>
        <button type="button" class="btn btn-info" onclick="upperLowerShelf(1)">批量上架</button>
        <button type="button" class="btn btn-info" onclick="upperLowerShelf(2)">批量下架</button>
    </form>
</div>
<table class="table" id="proTable"></table>
 </body>
<script>


    $(function(){
        initPro();

    })


    /****************************************************************产品库存*********************************************************************/

function stockUpdate(ids) {
        $.ajax({
            url: "../stockUp",
            type: "put",
            data: {
                ids: ids,
            },
            success: function (data) {
                bootbox.alert({
                    size: "small",
                    title: "提示",
                    message: "修改成功！",
                    callback: function () {
                    },
                    buttons: {
                        ok: {
                            label: '确定',
                            className: 'btn-success'
                        }
                    }
                })
                //刷新表格
                $("#proTable").bootstrapTable('refresh');
            }
        })

    }


    /****************************************************************产品查询*********************************************************************/
    //查询用户信息
    function initPro(){
        $('#proTable').bootstrapTable({
            url:'../queryProList',//获取数据地址
            pagination:true, //是否展示分页
            pageList:[3,5, 10, 20, 50],//分页组件
            pageNumber:1,
            pageSize:3,//默认每页条数
            showPaginationSwitch:false,//是否显示 数据条数选择框
            clickToSelect: true, //是否启用点击选中行
            sidePagination:'server',//分页方式：client客户端分页，server服务端分页（*
            striped:true,
            queryParams:function(){

                return {
                    page: this.pageNumber,
                    rows: this.pageSize
                }
            },
            columns:[
                {checkbox:true},
                {field:'productId',title:'商品编号',align:'center'},
                {field:'productName',title:'商品名称',align:'center'},
                {field:'oo',title:'类型-款式',align:'center',formatter:function(value,row,index){
                        return ""+row.typeName+"↜↝"+row.shuName;
                    }},
                {field:'productImg',title:'照片',formatter:function(value,row,index){
                        return "<img width='50px' height='50px' src='"+value+"'>";
                    }},
                {field:'productPrice',title:'产品价格',align:'center'},
                {field:'productStockId',title:'产品库存'},
                {field:'productDeliveryTime',title:'产品发货时间'},
                {field:'paymentId',title:'交易方式',formatter:function(value,row,index){
                        return value==1?"微信":"支付宝" }},
                {field:'proDealCount',title:'交易数量'},
                 {field: "productState", title: "商品状态",formatter:function(value,row,index){
                        return value == 1 ? "上架" :(value == 2 ? "下架":"待上架");
                    }},

                {field: 'productState', title: '操作', align: 'center', formatter: function (value, row, index) {
                    return " <a href='javascript:openUpdate("+row.productId+")'>修改</a> | <a href='javascript:stockUpdate("+row.productId+")'>库存</a>";
                    }

                }
            ]
        });
    }

    /***************************************************************下拉类型 二级联动**********************************************************************/

    function initArea(){
            var pid = 0;
            $.ajax({
                url:'../findAreaId',
                type:'get',
                data:{pid:pid},
                success:function(data){
                    var html = "<option value='-1'>请选择</option>";
                    for (var i = 0; i < data.length; i++) {
                        html+="<option value='"+data[i].id+"'>"+data[i].text+"</option>";
                    }
                    $("#areaId").html(html);
                }
            })
    }
    function changeCity(id){
        $.ajax({
            url:'../findAreaId',
            type:'get',
            data:{pid:id},
            success:function(data){
                var html = "<option value='-1'>请选择</option>";
                for (var i = 0; i < data.length; i++) {
                    html+="<option value='"+data[i].id+"'>"+data[i].text+"</option>";
                }
                $("#cityIds").html(html);
            }
        })
    }

    /***************************************************************修改**********************************************************************/


    //打开修改弹框
    function openUpdate(productId){
        initArea();
        //打开弹框
        bootbox.dialog({
            title:'修改',
            message: createAddContent("../page/updatePro"),
            closeButton: true,//是否显示关闭按钮
            buttons : {
                "success" : {
                    "label" : "<i class='icon-ok'></i> 保存",
                    "className" : "btn-sm btn-success",
                    "callback" : function() {
                        var productId = $("#productId").val();
                        var productName = $("#productName").val();
                        var productPrice = $("#productPrice").val();
                        var productStockId = $("#productStockId").val();
                        var productDeliveryTime = $("#productDeliveryTime").val();
                        var paymentId = $('#paymentId input:radio:checked').val();
                        var proDealCount = $("#proDealCount").val();
                        var productState = $('#productState input:radio:checked').val();
                        var productImg = $("#productImg").val();
                        var typeId = $("#cityIds").val();
                        $.ajax({
                            url:'../updatePro',
                            type:'put',
                            contentType: "application/json",
                            data:JSON.stringify({
                                'productId': productId,
                                'productName': productName,
                                'productPrice': productPrice,
                                'productStockId': productStockId,
                                'productDeliveryTime': productDeliveryTime,
                                'paymentId': paymentId,
                                'proDealCount': proDealCount,
                                'productState': productState,
                                'productImg':productImg,
                                'typeId':typeId
                            }),
                            success:function(){
                       $("#proTable").bootstrapTable('refresh');
                            }
                        });
                    }
                },
                "cancel" : {
                    "label" : "<i class='icon-info'></i> 取消",
                    "className" : "btn-sm btn-danger",
                    "callback" : function() {

                    }
                }
            }

        });
        //回显数据t
        $.ajax({
            url:'../findProById',
            type:'get',
            async:false,//同步
            data:{productId:productId},
            success:function(data){
                $("#productId").val(data.productId);
                $("#productName").val(data.productName);
                $("#productPrice").val(data.productPrice);
                $("#productStockId").val(data.productStockId);
                $("#productDeliveryTime").val(data.productDeliveryTime);
                $('#paymentId input:radio:checked').val(data.paymentId);
                $("#proDealCount").val(data.proDealCount);
                $("#cityIds").val(data.typeId);
            }
        });


    }



    /***************************************************************批量上下架**********************************************************************/
    //批量上下架
    function upperLowerShelf(status){
        var rows = $('#proTable').bootstrapTable('getSelections'); //获取表选择的行
        if(rows.length<=0){
            // 没选择
            bootbox.alert({
                size: "small",
                title: "提示",
                message: "请选择至少一行数据",
                callback: function(){},
                buttons: {
                    ok: {
                        label: '确定',
                        className: 'btn-success'
                    }
                }
            })
        }else{
            //提示确认是否上下架
            bootbox.confirm({
                size: "small",
                title:"提示",
                message: "是否确认改变?",
                buttons: {
                    confirm: {
                        label: '确定',
                        className: 'btn-success'
                    },
                    cancel: {
                        label: '取消',
                        className: 'btn-danger'
                    }
                },
                callback: function (result) {
                    if(result){
                        var ids="";
                        for(var i=0;i<rows.length;i++){
                            ids+=ids==""?rows[i].productId:","+rows[i].productId;
                        }
                        //后台ajax上下架
                        $.ajax({
                            url:"../updstate1",
                            type:"put",
                            data:{
                                ids:ids,
                                productState:status
                            },
                            success:function(data){
                                bootbox.alert({
                                    size: "small",
                                    title: "提示",
                                    message: "修改成功！",
                                    callback: function(){},
                                    buttons: {
                                        ok: {
                                            label: '确定',
                                            className: 'btn-success'
                                        }
                                    }
                                })
                                //刷新表格
                                $("#proTable").bootstrapTable('refresh');
                            }
                        })

                    }
                }
            })
        }
    }

/****************************************************************删除**********************************************************************/
    //批删
    function delAll(){
        var proTables = $("#proTable").bootstrapTable('getSelections');
        if (proTables.length <= 0) {
            bootbox.alert({
                size: "small",
                title: "提示",
                message: "请选择有效数据",
                callback: function(){}
            })
            return;
        }

        bootbox.confirm({
            title:"提示",
            message: "确认要删除选中的数据吗？",
            buttons: {
                confirm: {
                    label: 'Yes',
                    className: 'btn-success'
                },
                cancel: {
                    label: 'No',
                    className: 'btn-danger'
                }
            },
            callback: function (result) {
                if(result){
                    var ids= "";
                    for (var i = 0; i < proTables.length; i++) {
                        ids += ids == "" ? proTables[i].productId : ","+proTables[i].productId;
                    }
                    $.ajax({
                        url:'../delPro/'+ids,
                        type:'delete',
                        data:{},
                        success:function(){
                            bootbox.alert({
                                size: "small",
                                title: "提示",
                                message: "删除成功!",
                                callback: function () {
                                }
                            })
                            $("#proTable").bootstrapTable('refresh');
                        }
                    });
                }
            }
        });
    }


/***************************************************************新增**********************************************************************/
    var res;
    function createAddContent(url){
        $.ajax({
            url:url,
            async:false,
            success:function(data){
                res = data;
            }
        });
        return res;
    }
    //打开新增弹框
    function openUser(){
        initArea();
        bootbox.dialog({
            title:'新增',
            message: createAddContent("../page/addPro"),
            closeButton: true,
            buttons : {
                "success" : {
                    "label" : "<i class='icon-ok'></i> 保存",
                    "className" : "btn-sm btn-success",
                    "callback" : function() {
                        var productName = $("#productName").val();
                        var productPrice = $("#productPrice").val();
                        var productStockId = $("#productStockId").val();
                        var productDeliveryTime = $("#productDeliveryTime").val();
                        var paymentId = $('#paymentId input:radio:checked').val();
                        var proDealCount = $("#proDealCount").val();
                        var productState = $('#productState input:radio:checked').val();
                        var productImg = $("#productImg").val();
                        var typeId = $("#cityIds").val();
                        alert(typeId);
                        $.ajax({
                            url:'../savePro',
                            type:'post',
                            contentType: "application/json",
                            data:JSON.stringify({
                                'productName': productName,
                                'productPrice': productPrice,
                                'productStockId': productStockId,
                                'productDeliveryTime': productDeliveryTime,
                                'paymentId': paymentId,
                                'proDealCount': proDealCount,
                                'productState': productState,
                                'productImg': productImg,
                                'typeId':typeId
                            }),
                            dataType:'json',
                            success:function(data){
                                bootbox.alert({
                                    size: "small",
                                    title: "提示",
                                    message: "新增成功成功!",
                                    callback: function () {
                                        $('#proTable').bootstrapTable('refresh');
                                    }
                                })

                            }
                        });
                    }
                },
                "cancel" : {
                    "label" : "<i class='icon-info'></i> 取消",
                    "className" : "btn-sm btn-danger",
                    "callback" : function() {

                    }
                }
            }
        });
    }

    function searchPro(){
        $("#proTable").bootstrapTable('refresh');
    }

    $('.date').datetimepicker({
        language: 'zh-CN',//显示中文
        format: 'yyyy-mm-dd',//显示格式
        minView: "month",//设置只显示到月份
        initialDate: new Date(),//初始化当前日期
        autoclose: true,//选中自动关闭
        todayBtn: true//显示今日按钮
    });

    var res;
    function createAddContent(url){
        $.ajax({
            url:url,
            async:false,
            success:function(data){
                res = data;
            }
        });
        return res;
    }


</script>
</html>